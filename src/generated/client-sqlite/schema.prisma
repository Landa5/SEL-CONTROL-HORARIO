// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/client-sqlite"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Empleado {
  id       Int     @id @default(autoincrement())
  usuario  String  @unique
  password String
  activo   Boolean @default(true)

  // Datos personales
  nombre    String
  apellidos String?
  dni       String? @unique
  telefono  String?
  email     String?
  direccion String?

  // Datos laborales
  rol           String    @default("CONDUCTOR") // SQLite doesn't support enums strictly, mapping as String
  fechaAlta     DateTime  @default(now())
  fechaBaja     DateTime?
  observaciones String?

  // Vacaciones
  diasVacaciones Int   @default(30)
  diasExtras     Int   @default(0) // Por festivos trabajados
  horasExtra     Float @default(0) // Acumulado para oficina

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  jornadas  JornadaLaboral[]
  ausencias Ausencia[]

  tareasCreadas   Tarea[] @relation("CreadorTarea")
  tareasAsignadas Tarea[] @relation("AsignadoTarea")

  historialTareas     TareaHistorial[]
  adjuntos            TareaAdjunto[]
  notificaciones      Notificacion[]
  auditorias          Auditoria[]
  compensaciones      CompensacionFestivo[]
  modulosCreados      ModuloFormacion[]     @relation("CreadorModulo")
  resultadosFormacion ResultadoFormacion[]

  // Payroll Relations
  nominas            NominaMes[]
  comercialLitros    ComercialLitros[]
  tarifasEspecificas TarifaNomina[]
}

model Camion {
  id        Int     @id @default(autoincrement())
  matricula String  @unique
  modelo    String?
  marca     String?
  nVin      String? @unique // Bastidor
  anio      Int?
  activo    Boolean @default(true)
  kmActual  Int     @default(0)

  // Vencimientos
  itvVencimiento       DateTime?
  seguroVencimiento    DateTime?
  tacografoVencimiento DateTime?
  adrVencimiento       DateTime? // Certificación ADR (mercancías peligrosas)

  // Cisterna específica
  anioCisterna Int? // Año de fabricación de la cisterna

  // Relaciones
  usos                       UsoCamion[]
  tareas                     Tarea[]
  mantenimientosPlanificados MantenimientoProximo[]
  historialMantenimientos    MantenimientoRealizado[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model JornadaLaboral {
  id          Int       @id @default(autoincrement())
  fecha       DateTime
  horaEntrada DateTime
  horaSalida  DateTime?
  totalHoras  Float? // Calculado al cerrar

  // "TRABAJANDO", "CERRADA", "INCIDENCIA"
  estado        String  @default("TRABAJANDO")
  observaciones String?

  empleadoId Int
  empleado   Empleado @relation(fields: [empleadoId], references: [id])

  usosCamion UsoCamion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  compensacion CompensacionFestivo?
}

// Replaces TurnoConductor. Represents a usage slice of a truck within a day.
model UsoCamion {
  id Int @id @default(autoincrement())

  jornadaId Int
  jornada   JornadaLaboral @relation(fields: [jornadaId], references: [id])

  camionId Int
  camion   Camion @relation(fields: [camionId], references: [id])

  horaInicio DateTime
  horaFin    DateTime?

  kmInicial    Int
  kmFinal      Int?
  kmRecorridos Int? // Calculado: kmFinal - kmInicial

  descargas        Descarga[]
  descargasCount   Int        @default(0) // Cantidad de descargas en este tramo
  viajesCount      Int        @default(0) // Cantidad de viajes
  litrosRepostados Float      @default(0) // Litros de gasoil repostados al camión
  fotoKmInicial    String? // Evidencia si hubo descuadre de KM

  notas String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Descarga {
  id         Int      @id @default(autoincrement())
  hora       DateTime
  litros     Int
  tipoGasoil String
  lugar      String

  usoCamionId Int
  usoCamion   UsoCamion @relation(fields: [usoCamionId], references: [id])
}

model Ausencia {
  id          Int      @id @default(autoincrement())
  // "VACACIONES", "BAJA", "PERMISO", "OTROS"
  tipo        String
  fechaInicio DateTime
  fechaFin    DateTime

  // "PENDIENTE", "APROBADA", "DENEGADA", "CANCELADA"
  estado String @default("PENDIENTE")

  observaciones String?

  empleadoId Int
  empleado   Empleado @relation(fields: [empleadoId], references: [id])

  aprobadoPorId   Int? // ID del admin/oficina que aprobó
  fechaResolucion DateTime?

  justificanteUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// TICKET SYSTEM (AVERIAS & TAREAS)
model Tarea {
  id Int @id @default(autoincrement())

  // Enums (represented as Strings for SQLite)
  // tipo: "AVERIA", "TAREA_INTERNA", "MANTENIMIENTO"
  tipo       String  @default("AVERIA")
  // estado: "ABIERTA", "EN_CURSO", "CERRADA", "CANCELADA"
  estado     String  @default("ABIERTA")
  // prioridad: "BAJA", "MEDIA", "ALTA", "URGENTE"
  prioridad  String  @default("MEDIA")
  // activoTipo: "CAMION", "DEPOSITO_CLIENTE", "BASE", "OTRO"
  activoTipo String? // Opcional para tareas internas

  matricula      String?
  clienteNombre  String?
  ubicacionTexto String?

  titulo      String
  descripcion String

  contactoNombre   String?
  contactoTelefono String?

  fechaInicio   DateTime  @default(now())
  fechaCierre   DateTime?
  resumenCierre String?

  // Relaciones
  creadoPorId Int
  creadoPor   Empleado @relation("CreadorTarea", fields: [creadoPorId], references: [id])

  asignadoAId Int?
  asignadoA   Empleado? @relation("AsignadoTarea", fields: [asignadoAId], references: [id])

  historial TareaHistorial[]
  adjuntos  TareaAdjunto[]

  camionId Int?
  camion   Camion? @relation(fields: [camionId], references: [id])

  descargas Int?

  mantenimientosRealizados MantenimientoRealizado[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TareaHistorial {
  id      Int   @id @default(autoincrement())
  tareaId Int
  tarea   Tarea @relation(fields: [tareaId], references: [id], onDelete: Cascade)

  autorId Int
  autor   Empleado @relation(fields: [autorId], references: [id])

  // "COMENTARIO", "CAMBIO_ESTADO", "ASIGNACION", "CREACION", "CIERRE"
  tipoAccion  String
  mensaje     String
  estadoNuevo String?

  createdAt DateTime @default(now())
}

model TareaAdjunto {
  id      Int   @id @default(autoincrement())
  tareaId Int
  tarea   Tarea @relation(fields: [tareaId], references: [id], onDelete: Cascade)

  autorId Int
  autor   Empleado @relation(fields: [autorId], references: [id])

  filename String
  url      String
  mimeType String

  createdAt DateTime @default(now())
}

model MantenimientoProximo {
  id       Int    @id @default(autoincrement())
  camionId Int
  camion   Camion @relation(fields: [camionId], references: [id])

  tipo        String // "PREVENTIVO", "CORRECTIVO"
  descripcion String

  // Condición de disparo
  kmObjetivo    Int? // Se dispara al llegar a estos km
  fechaObjetivo DateTime? // Se dispara en esta fecha

  estado String @default("PROGRAMADO") // "PROGRAMADO", "COMPLETADO"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MantenimientoRealizado {
  id              Int      @id @default(autoincrement())
  fecha           DateTime @default(now())
  kmEnEseMomento  Int
  tipo            String // "ACEITE", "FRENOS", "MOTOR", "ITV", etc.
  descripcion     String
  piezasCambiadas String? // TextArea o JSON
  costo           Float?
  taller          String? // Nombre del taller externo o "Propio"

  camionId Int
  camion   Camion @relation(fields: [camionId], references: [id])

  tareaId Int? // Enlace opcional a la avería que originó esto
  tarea   Tarea? @relation(fields: [tareaId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Auditoria {
  id        Int      @id @default(autoincrement())
  usuarioId Int
  usuario   Empleado @relation(fields: [usuarioId], references: [id])

  accion    String // "EDICION_JORNADA", "CAMBIO_PASSWORD", etc.
  entidad   String // "JornadaLaboral", "Empleado"
  entidadId Int

  detalles String // JSON o texto con el cambio (ej: "KM 100 -> 120")

  createdAt DateTime @default(now())
}

model Notificacion {
  id        Int      @id @default(autoincrement())
  usuarioId Int
  usuario   Empleado @relation(fields: [usuarioId], references: [id])

  mensaje String
  link    String?
  leida   Boolean @default(false)

  createdAt DateTime @default(now())
}

model FiestaLocal {
  id      Int      @id @default(autoincrement())
  fecha   DateTime
  nombre  String
  ambito  String? // Municipio / Centro de trabajo
  esAnual Boolean  @default(true)
  activa  Boolean  @default(true)

  compensaciones CompensacionFestivo[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fecha, nombre])
}

model CompensacionFestivo {
  id Int @id @default(autoincrement())

  empleadoId Int
  empleado   Empleado @relation(fields: [empleadoId], references: [id])

  jornadaId Int            @unique
  jornada   JornadaLaboral @relation(fields: [jornadaId], references: [id])

  fiestaId Int
  fiesta   FiestaLocal @relation(fields: [fiestaId], references: [id])

  // "DIA_VACACIONES", "HORAS_EXTRA"
  tipo   String
  valor  Float // 1 (día) o N (horas)
  motivo String @default("Compensación por fiesta local trabajada")

  createdAt DateTime @default(now())
}

// FORMACIÓN INTERNA
model ModuloFormacion {
  id               Int      @id @default(autoincrement())
  titulo           String
  descripcion      String
  fechaInicio      DateTime
  fechaFin         DateTime
  duracionEstimada Int      @default(0) // En minutos
  activo           Boolean  @default(true)

  creadoPorId Int
  creadoPor   Empleado @relation("CreadorModulo", fields: [creadoPorId], references: [id])

  temas      TemaFormacion[]
  preguntas  PreguntaFormacion[]
  resultados ResultadoFormacion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TemaFormacion {
  id       Int             @id @default(autoincrement())
  moduloId Int
  modulo   ModuloFormacion @relation(fields: [moduloId], references: [id], onDelete: Cascade)

  orden       Int     @default(0)
  titulo      String
  contenido   String // Texto enriquecido o descripción
  tipo        String  @default("TEXTO") // TEXTO, VIDEO, PDF
  resourceUrl String? // Link a video o archivo

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PreguntaFormacion {
  id       Int             @id @default(autoincrement())
  moduloId Int
  modulo   ModuloFormacion @relation(fields: [moduloId], references: [id], onDelete: Cascade)

  texto    String
  opcionA  String
  opcionB  String
  opcionC  String
  correcta String @default("A") // A, B, C
  puntos   Int    @default(10)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ResultadoFormacion {
  id         Int      @id @default(autoincrement())
  empleadoId Int
  empleado   Empleado @relation(fields: [empleadoId], references: [id])

  moduloId Int
  modulo   ModuloFormacion @relation(fields: [moduloId], references: [id])

  puntuacion Int     @default(0)
  aprobado   Boolean @default(false)
  intentos   Int     @default(1)

  completadoAl DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([empleadoId, moduloId])
}

// =======================
// MÓDULO NÓMINAS
// =======================

model ConceptoNomina {
  id          Int     @id @default(autoincrement())
  codigo      String  @unique // KM, DESCARGA, VIAJE, ETC
  nombre      String
  descripcion String?

  tarifas TarifaNomina[]
  active  Boolean        @default(true)
}

model TarifaNomina {
  id Int @id @default(autoincrement())

  conceptoId Int
  concepto   ConceptoNomina @relation(fields: [conceptoId], references: [id])

  // Scope: Global (null, null), Por Rol (rol, null), Por Empleado (null, empleado)
  rol        String?
  empleadoId Int?
  empleado   Empleado? @relation(fields: [empleadoId], references: [id])

  valor Float // Precio unitario o importe fijo

  fechaInicio DateTime  @default(now())
  fechaFin    DateTime?

  activo Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model NominaMes {
  id         Int      @id @default(autoincrement())
  empleadoId Int
  empleado   Empleado @relation(fields: [empleadoId], references: [id])

  year  Int
  month Int

  estado String @default("BORRADOR") // BORRADOR, CERRADA, ENVIADA

  totalBruto     Float @default(0)
  totalVariables Float @default(0)

  lineas NominaLinea[]

  cerradaPorId Int?
  fechaCierre  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([empleadoId, year, month])
}

model NominaLinea {
  id       Int       @id @default(autoincrement())
  nominaId Int
  nomina   NominaMes @relation(fields: [nominaId], references: [id], onDelete: Cascade)

  conceptoCodigo String
  conceptoNombre String

  cantidad Float @default(0) // Unidades (km, descargas...)
  rate     Float @default(0) // Precio aplicado
  importe  Float @default(0) // cantidad * rate (o fijo)

  orden Int @default(0)

  override  Boolean @default(false)
  notas     String?
  updatedBy Int? // User ID who modified it manually

  createdAt DateTime @default(now())
}

model ComercialLitros {
  id         Int      @id @default(autoincrement())
  empleadoId Int
  empleado   Empleado @relation(fields: [empleadoId], references: [id])

  year  Int
  month Int

  litros Float @default(0)

  notas String?

  updatedBy Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([empleadoId, year, month])
}

model EnvioGestoria {
  id    Int @id @default(autoincrement())
  year  Int
  month Int

  fechaEnvio DateTime @default(now())
  usuarioId  Int

  urlPdfConsolidado String?
  status            String  @default("OK")
}
